"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _processInput(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a?("string"==typeof a&&(a={url:a}),a):void 0}function _extend(){for(var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];for(var e=0;e<c.length;e++){var f=c[e];for(var g in f)a[g]=f[g]}return a}var _bind=Function.prototype.bind,_get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;return void 0===i?void 0:i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return void 0;a=j,b=f,c=g,d=!0,h=j=void 0}},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();try{var heartStyle="color: red; font-size: 3em;",logoStyle="color: black; font-size: 2em; font-family: Georgia;";console.log("%c"+String.fromCharCode(10084)+"%c BEdita",heartStyle,logoStyle)}catch(ex){}var BEModel=function(){function a(b){_classCallCheck(this,a),this.$udid=a.generateId(),a.updateRegistry(this,"conf",b),a.updateRegistry(this,"modified",[])}return _createClass(a,[{key:"$id",value:function(){return this.$udid}},{key:"$config",value:function(b){return b?a.updateRegistry(this,"conf",b):a.readRegistry(this,"conf")||{}}},{key:"$modified",value:function(b){var c=a.readRegistry(this,"modified")||[];return b===!1?a.updateRegistry(this,"modified",[]):b&&-1===c.indexOf(b)?(c.push(b),a.updateRegistry(this,"modified",c)):a.readRegistry(this,"modified")}},{key:"$remove",value:function(){return a.removeFromRegistry(this)}},{key:"$toJSON",value:function(a,b){var c={},d=this;Array.isArray(a)||(a=[]),Array.isArray(b)||(b=[]);for(var e in d)"$"!==e[0]&&(c[e]=d[e]);return c}}],[{key:"generateId",value:function(){this.__generated=this.__generated||0;var a="$"+this.__generated;return this.__generated+=1,a}},{key:"readRegistry",value:function(a,b){this.registry=this.registry||{};var c="function"==typeof a.$id?a.$id():a;return c?(this.registry[c]=this.registry[c]||{},this.registry[c][b]):void 0}},{key:"updateRegistry",value:function(a,b,c){this.registry=this.registry||{};var d="function"==typeof a.$id?a.$id():a;return d?(this.registry[d]=this.registry[d]||{},this.registry[d][b]=c,c):void 0}},{key:"removeFromRegistry",value:function(a){this.registry=this.registry||{};var b="function"==typeof a.$id?a.$id():a;b&&delete this.registry[b]}}]),a}(),BEArray=function(a){function b(a,c){void 0===a&&(a=[]),_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,a),this.$udid=BEModel.generateId(),BEModel.updateRegistry(this,"conf",c)}return _inherits(b,a),_createClass(b,[{key:"$id",value:function(){return BEModel.prototype.$id.call(this)}},{key:"$config",value:function(a){return BEModel.prototype.$config.call(this,a)}},{key:"$modified",value:function(a){return BEModel.prototype.$modified.call(this,a)}}]),b}(Array),BECollection=function(a){function b(){var a=this,c=arguments.length<=0||void 0===arguments[0]?[]:arguments[0],d=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,b);var e=[];"object"==typeof e?e=c.items||[]:Array.isArray(c)&&(e=c);for(var f=0;f<e.length;f++)e[f]instanceof BEObject||(e[f]=new BEObject(e[f],d));_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,e,d),"string"==typeof c?this.$url=c:"object"==typeof e&&c.count&&e.length<c.count&&this.push(new BEObject({},d)),this.forEach(function(b){var c=BEModel.readRegistry(b,"collections")||[];c.push(a),BEModel.updateRegistry(b,"collections",c)})}return _inherits(b,a),_createClass(b,[{key:"push",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;b>d;d++)c[d]=arguments[d];return c.forEach(function(b){b instanceof BEObject||(b=new BEObject(b,a.$config())),-1==a.indexOf(b)&&(a.__addCollectionToObject(b),Array.prototype.push.call(a,b))}),this.length}},{key:"pop",value:function(){for(var a=arguments.length,b=Array(a),c=0;a>c;c++)b[c]=arguments[c];var d=Array.prototype.splice.apply(this,b);return this.__removeCollectionFromObject(d),d}},{key:"shift",value:function(){for(var a=arguments.length,b=Array(a),c=0;a>c;c++)b[c]=arguments[c];var d=Array.prototype.shift.apply(this,b);return this.__removeCollectionFromObject(d),d}},{key:"splice",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;b>d;d++)c[d]=arguments[d];var e=Array.prototype.splice.apply(this,c);return e&&e.forEach(function(b){a.__removeCollectionFromObject(b)}),e}},{key:"__addCollectionToObject",value:function(a){var b=BEModel.readRegistry(a,"collections")||[],c=b.indexOf(this);return-1==c?(b.push(this),BEModel.updateRegistry(a,"collections",b),!0):!1}},{key:"__removeCollectionFromObject",value:function(a){var b=BEModel.readRegistry(a,"collections")||[],c=b.indexOf(this);return-1!==c?(b.splice(c,1),BEModel.updateRegistry(a,"collections",b),!0):!1}},{key:"$fetch",value:function(a){var b=this,c=arguments;return new Promise(function(d,e){if(b.$url||a){a&&(b.$url=a);var f=new BEApi(b.$config());f.get(b.$url).then(function(a){if(a&&a.data&&a.data.objects)for(var e=0;e<a.data.objects.length;e++){var f=a.data.objects[e];b.push(f)}d.apply(b,c)},function(a){e.apply(b,c)})}else e()})}},{key:"$filter",value:function(a){return Array.prototype.filter.call(this,function(b){return b.$is(a)})}},{key:"$toArray",value:function(){return Array.prototype.slice.call(this,0)}}]),b}(BEArray),BEObject=function(a){function b(a,c){void 0===a&&(a={}),_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,c),BEModel.updateRegistry(this,"collections",[]),this.$set(a)}return _inherits(b,a),_createClass(b,[{key:"$fetch",value:function(){var a=this;return new Promise(function(b,c){if(a.id||a.nickname){var d=new BEApi(a.$config()).get("objects/"+(a.id||a.nickname));return d.then(function(d){d&&d.data&&d.data.object?(a.$set(d.data.object),a.$modified(!1),b(d)):c(d)},function(a){c(a)}),d}c()})}},{key:"$save",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.$set(b);var c=this.$toJSON(this.$modified());return c.id=this.id,c.nickname=this.nickname,new Promise(function(b,d){var e=new BEApi(a.$config()).post("objects",{data:c});e.then(function(c){c&&c.data&&c.data.object?(a.$set(c.data.object),a.$modified(!1),b(c)):d(c)},function(a){d(a)})})}},{key:"$create",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(!this.$isNew())throw"Object already created.";return this.$save(a)}},{key:"$remove",value:function(){var a=this,b=new Promise(function(b,c){if(a.$isNew())b();else{var d=new BEApi(a.$config())["delete"]("objects/"+(a.id||a.nickname));d.then(function(a){b()},function(a){c(a)})}});return b.then(function(){var b=BEModel.readRegistry(a,"collections");b.forEach(function(b){var c=b.indexOf(a);-1!==c&&b.splice(c,1)}),BEModel.prototype.$remove.call(a)}),b}},{key:"$clone",value:function(){return new b(this.$toJSON([],["id"]),this.$config())}},{key:"$isNew",value:function(){return!this.id&&!this.nickname}},{key:"$set",value:function(a,c){if(void 0===a&&(a={}),void 0!==c&&"string"==typeof a){var d=a;a={},a[d]=c}var e=a.relations||{},f=a.children||{},g=/\d{4,}\-\d{2,}\-\d{2,}T\d{2,}:\d{2,}:\d{2,}\+(\d{4,}|\d{2,}\:\d{2,})/;for(var h in e)this.relations||(this.relations={}),this.relations[h]=new BECollection(e[h],this.$config());f&&!this.children&&(this.children=new BECollection({url:f.url,count:f.count},this.$config()),f.sections&&(this.sections=new BECollection({alias:this.children,filter:{object_type:"Section"},url:f.sections.url,count:f.sections},this.$config())));for(var h in a){var i=a[h];if("string"==typeof i&&g.test(i)){var j=new Date(i);isNaN(j.valueOf())||(i=j)}this[h]!==i&&(this[h]=i,this.$modified(h))}return a.parent_id?(this.parent=new b({id:a.parent_id},this.$config()),delete this.parent_id):delete this.parent,this}},{key:"$is",value:function(a){var b=this.$toJSON();if(a instanceof RegExp){for(var c in b)if(b[c].match(a))return!0}else if("string"==typeof a){var d=new RegExp(a);for(var c in b)if(b[c].match(d))return!0}else if("object"==typeof a){for(var c in a)if(a[c]!==b[c])return!1;return!0}return!1}},{key:"$query",value:function(){var a=this,b=new BEApiQueue(this.$config());return"id"in this&&"nickname"in this?b.identity(this):b.objects(this.id||this.nickname),b.all(function(b){a.$set(b),a.$modified(!1)}),b}}]),b}(BEModel),BEXhr=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"exec",value:function(){for(var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],c={type:"GET",async:!0,responseType:"json",headers:{},data:void 0},d={},e=[c,b],f=0;f<e.length;f++){var g=e[f];for(var h in g)d[h]=g[h]}return d.type=d.type.toUpperCase(),new Promise(function(b,c){var e=new a.xhr;if(e.addEventListener("load",function(){var a=void 0;try{a=e.response||e.responseText||""}catch(d){}if(a&&""!==a)try{a=JSON.parse(a)}catch(f){}e.status>=200&&e.status<400?b(a):c(a)},!1),e.addEventListener("error",function(){c(e)},!1),e.addEventListener("abort",function(){c(e)},!1),e.responseType=d.responseType,e.open(d.type,d.url,d.async),d.headers&&"object"==typeof d.headers)for(var f in d.headers)e.setRequestHeader(f,d.headers[f]);if("POST"==d.type||"PUT"==d.type&&void 0!==d.data){var g=d.data;"object"==typeof g&&(g=JSON.stringify(g)),e.send(g)}else e.send()})}},{key:"xhr",get:function(){return this._xhr?this._xhr:"object"==typeof module&&"object"==typeof module.exports?this.xhr=require("xmlhttprequest").XMLHttpRequest:window.XMLHttpRequest},set:function(a){this._xhr=a}}]),a}(),BEApiRegistry=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"add",value:function(b){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];a._instances=a._instances||{},a._instances[b]=c}},{key:"get",value:function(b){return a._instances=a._instances||{},"undefined"!=typeof a._instances[b]?a._instances[b]:void 0}},{key:"remove",value:function(b){return a._instances=a._instances||{},"undefined"!=typeof a._instances[b]?(delete a._instances[b],!0):!1}}]),a}(),BEApi=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(_classCallCheck(this,a),"string"==typeof b){var c=BEApiRegistry.get(b);b=c?c:{}}if(!b.baseUrl)try{b.baseUrl=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/api/latest/"}catch(d){throw"Missing valid `baseUrl`."}this.conf=b,BEApiRegistry.add(this.configKey,b)}return _createClass(a,[{key:"_processOptions",value:function(a){var b=_extend({},a),c=_extend({},this.conf);for(var d in b)c[d]=b[d];var e=c.url||"/",f=this.getAccessToken();if(/^([\w\-]+:)?\/{2,3}/.test(e)){if(0!==e.indexOf(c.baseUrl))throw"Invalid url"}else e="/"!==e[0]?c.baseUrl+("/"==c.baseUrl[c.baseUrl.length-1]?e:"/"+e):c.baseUrl+("/"==c.baseUrl[c.baseUrl.length-1]?e.slice(1):e);return c.url=e,f&&(c.headers=c.headers&&"object"==typeof c.headers?c.headers:{},c.headers.Authorization="Bearer "+f),c.type=c.method=c.type||c.method||"GET",c.skipRefreshToken=c.skipRefreshToken||!1,c}},{key:"_processXHR",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return this.getAccessToken()&&this.isTokenExpired()&&!b.skipRefreshToken?new Promise(function(c,d){var e=a.refreshToken().then();e.then(function(){delete b.headers.Authorization,b=a._processOptions(b),BEXhr.exec(b).then(function(a){c(a)},function(a){d(a)})})}):BEXhr.exec(b)}},{key:"_processAuth",value:function(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];b=_extend({},b),b.url="auth",b.skipRefreshToken=!0;var c=a.storage,d=this.conf,e=this.post(b);return e.then(function(a){a&&a.data&&a.data.access_token?(c.setItem(d.accessTokenKey,a.data.access_token),c.setItem(d.refreshTokenKey,a.data.refresh_token),c.setItem(d.accessTokenExpireDate,Date.now()+1e3*a.data.expires_in)):(c.removeItem(d.accessTokenKey),c.removeItem(d.refreshTokenKey),c.removeItem(d.accessTokenExpireDate))},function(){c.removeItem(d.accessTokenKey),c.removeItem(d.refreshTokenKey),c.removeItem(d.accessTokenExpireDate)}),e}},{key:"baseUrl",value:function(a){return a&&(this.conf.baseUrl=a),this.conf.baseUrl}},{key:"get",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a=_processInput(a),a.type="GET",a=this._processOptions(a),this._processXHR(a)}},{key:"post",value:function(a,b){return void 0===a&&(a={}),a=_processInput(a),a.data=b?_extend(a.data||{},b):a.data,a.type="POST",a=this._processOptions(a),this._processXHR(a)}},{key:"put",value:function(a,b){return void 0===a&&(a={}),a=_processInput(a),a.data=b?_extend(a.data||{},b):a.data,a.type="PUT",a=this._processOptions(a),this._processXHR(a)}},{key:"delete",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a=_processInput(a),a.type="DELETE",a=this._processOptions(a),this._processXHR(a)}},{key:"auth",value:function(a,b){var c={data:{username:a,password:b}};return this._processAuth(c)}},{key:"refreshToken",value:function(){var b=a.storage,c=this.conf,d={data:{grant_type:"refresh_token",refresh_token:this.getRefreshToken()}};return b.removeItem(c.accessTokenKey),b.removeItem(c.accessTokenExpireDate),this._processAuth(d)}},{key:"logout",value:function(){var b=a.storage,c=this.conf,d=this["delete"]({url:"auth/"+this.getRefreshToken(),skipRefreshToken:!0});return b.removeItem(c.accessTokenKey),b.removeItem(c.accessTokenExpireDate),d.then().then(function(a){a&&a.data&&a.data.logout&&b.removeItem(c.refreshTokenKey)})}},{key:"getAccessToken",value:function(){return a.storage.getItem(this.conf.accessTokenKey)||void 0}},{key:"getRefreshToken",value:function(){return a.storage.getItem(this.conf.refreshTokenKey)||void 0}},{key:"getAccessTokenExpireDate",value:function(){var b=a.storage.getItem(this.conf.accessTokenExpireDate);return b?(b=parseInt(b),new Date(b)):void 0}},{key:"isTokenExpired",value:function(){return new Date>=this.getAccessTokenExpireDate()}},{key:"conf",get:function(){return this._conf},set:function(a){var b={baseUrl:void 0,accessTokenKey:"be_access_token",refreshTokenKey:"be_refresh_token",accessTokenExpireDate:"be_access_token_expire_date",configKey:this.defaultConfigKey};for(var c in a)b[c]=a[c];this._conf=b}},{key:"defaultConfigKey",get:function(){return"default"}},{key:"configKey",get:function(){return this.conf&&this.conf.configKey||this.defaultConfigKey}}],[{key:"storage",get:function(){if(this._storage)return this._storage;if("object"==typeof module&&"object"==typeof module.exports){var b=require("node-localstorage").LocalStorage;return a.storage=new b("./beapi")}return"undefined"!=typeof localStorage?a.storage=window.localStorage:void 0},set:function(a){if("function"!=typeof a.setItem||"function"!=typeof a.getItem||"function"!=typeof a.removeItem)throw"Invalid custom storage.";this._storage=a}},{key:"xhr",get:function(){return BEXhr.xhr},set:function(a){BEXhr.xhr=a}}]),a}(),BEApiQueue=function(){function a(b){var c=this;if(_classCallCheck(this,a),"string"==typeof b)this.conf=BEApiRegistry.get(b);else if(b instanceof BEApi)this.conf=b.conf;else{if("object"!=typeof b)throw"No BEApi configuration provided.";this.conf=b}this._promise=new Promise(function(a,b){c._resolver=a,c._rejecter=b}),this.reset()}return _createClass(a,[{key:"reset",value:function(){return this.queue=[],this}},{key:"add",value:function(a){return this.queue.push(a),this}},{key:"exec",value:function(){function b(c,f,g){if(g=g||0,g==f.length)return c._resolver(e);var h=f[g],i=h.fn,j=h.args,k=h.resolve,l=h.reject,m=(h.promise,a.tasks[i]),n=new(_bind.apply(m,[null].concat(_toConsumableArray(j))));n.input.call(n,e).then(function(a){var h=n.type.toLowerCase();if("function"==typeof d[h]){var i=d[h].apply(d,a).then();i.then(function(a){n.validate(a).then(function(){n.transform(e,a).then(function(a){e=a,k(e),b(c,f,g+1)},function(a){l(e),c._rejecter(a)})},function(a){l(e),c._rejecter(a)})})}})}var c=this.queue,d=new BEApi(this.conf),e=void 0;return b(this,c),this._promise}},{key:"get",value:function(){return this.exec()}},{key:"first",value:function(){return this.queue.length?this.queue[0]:void 0}},{key:"last",value:function(){return this.queue.length?this.queue[this.queue.length-1]:void 0}},{key:"then",value:function(b,c){return this.queue.length?this.last().promise.then(b||a.__noop,c||a.__noop):this.all(b||a.__noop,c||a.__noop)}},{key:"all",value:function(b,c){return this._promise?this._promise.then(b||a.__noop,c||a.__noop):void 0}}],[{key:"register",value:function(b,c){if(b&&"undefined"!=typeof a.prototype[b])throw"Reserved method";a.tasks=a.tasks||{},a.tasks[b]=c,function(b){a.prototype[b]=function(){for(var a=arguments.length,c=Array(a),d=0;a>d;d++)c[d]=arguments[d];return this.add(new BEApiQueueTask(b,c)),this}}(b)}},{key:"__noop",value:function(){}}]),a}(),BEApiQueueTask=function a(b){var c=this,d=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];_classCallCheck(this,a),b&&(this.fn=b),this.args=d,this.promise=new Promise(function(a,b){c.resolve=a,c.reject=b})},BEApiQueueBaseMethod=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,a),this.options=b}return _createClass(a,[{key:"type",get:function(){return"get"}}]),_createClass(a,[{key:"input",value:function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];return new Promise(function(a){a(c)})}},{key:"validate",value:function(a){return new Promise(function(b,c){a&&a.data&&(!a.status||a.status>=200&&a.status<300)?b():c()})}},{key:"transform",value:function(a,b){return new Promise(function(b){b(a)})}}]),a}(),BEApiQueueIdentity=function(a){function b(a){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,{id:a.id,data:a})}return _inherits(b,a),_createClass(b,[{key:"validate",value:function(){return new Promise(function(a){a()})}},{key:"input",value:function(a){return new Promise(function(a){a([{url:"/"}])})}},{key:"transform",value:function(a,b){var c=this;return new Promise(function(a,b){a(c.options.data)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("identity",BEApiQueueIdentity);var BEApiQueueObjects=function(a){function b(a,c){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,{id:a,type:c})}return _inherits(b,a),_createClass(b,[{key:"input",value:function(a){var b=this;return new Promise(function(a){a([{url:(b.options.type?b.options.type+"s":"objects")+(b.options.id?"/"+b.options.id:"")}])})}},{key:"transform",value:function(a,b){return new Promise(function(c,d){b.data.object&&(a=b.data.object),c(a)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("objects",BEApiQueueObjects);var BEApiQueuePoster=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,a)}return _inherits(b,a),_createClass(b,[{key:"input",value:function(a){var b=this;return new Promise(function(c){var d="";if(b.options){d="?";for(var e in b.options)d+=e+"="+b.options[e]}c([{url:"poster/"+a.id+d}])})}},{key:"transform",value:function(a,b){return new Promise(function(c,d){b&&b.data&&(a.poster=b.data),c(a)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("poster",BEApiQueuePoster);var BEApiQueueRelation=function(a){function b(a){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,{relName:a})}return _inherits(b,a),_createClass(b,[{key:"input",value:function(a){var b=this;return new Promise(function(c){c([{url:"objects/"+a.id+"/relations/"+b.options.relName}])})}},{key:"transform",value:function(a,b){var c=this;return new Promise(function(d,e){a.relations=a.relations||{},a.relations[c.options.relName]=a.relations[c.options.relName]||{},a.relations[c.options.relName].objects=b.data.objects,d(a)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("relation",BEApiQueueRelation);
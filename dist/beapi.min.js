"use strict";function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _processInput(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a?("string"==typeof a&&(a={url:a}),a):void 0}function _extend(){for(var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];for(var e=0;e<c.length;e++){var f=c[e];for(var g in f)a[g]=f[g]}return a}var _bind=Function.prototype.bind,_get=function(a,b,c){for(var d=!0;d;){var e=a,f=b,g=c;d=!1,null===e&&(e=Function.prototype);var h=Object.getOwnPropertyDescriptor(e,f);if(void 0!==h){if("value"in h)return h.value;var i=h.get;return void 0===i?void 0:i.call(g)}var j=Object.getPrototypeOf(e);if(null===j)return void 0;a=j,b=f,c=g,d=!0,h=j=void 0}},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();try{console.log("%c❤︎%c BEdita","color: red; font-size: 3em","color: #000; font-size: 2em; font-family: Georgia")}catch(ex){}var BEModel=function(){function a(b){_classCallCheck(this,a),this.__config=b,this.__modified=[]}return _createClass(a,[{key:"_config",value:function(a){return a&&(this.__config=a),this.__config}},{key:"_modified",value:function(a){return a===!1?this.__modified=[]:a&&-1===this.__modified.indexOf(a)&&this.__modified.push(a),this.__modified}}]),a}(),BEArray=function(a){function b(a,c){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,a),this.__config=c}return _inherits(b,a),_createClass(b,[{key:"_config",value:function(a){return a&&(this.__config=a),this.__config}},{key:"_modified",value:function(a){return a===!1?this.__modified=[]:a&&-1===this.__modified.indexOf(a)&&this.__modified.push(a),this.__modified}}]),b}(Array),BECollection=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,[],c);var d=[];a.alias?(this.alias=a.alias,d=a.filter?a.alias.filter(a.filter)||[]:a.alias.items||[]):d=a.items||a.objects||[],this.url=a.url;for(var e=0;e<d.length;e++)this.push(d[e]);d.length<a.count&&this.push({})}return _inherits(b,a),_createClass(b,[{key:"push",value:function(a){a instanceof BEObject||(a=new BEObject(a,this._config())),Array.prototype.push.call(this,a)}},{key:"fetch",value:function(a){var b=this,c=arguments;return new Promise(function(d,e){if(b.url||a){if(b.alias)return b.alias.fetch(b.url||a||void 0);b.splice(0,b.length);var f=new BEApi(b._config());f.get(b.url||a).then(function(a){if(a&&a.data&&a.data.objects)for(var e=0;e<a.data.objects.length;e++){var f=a.data.objects[e];b.push(f)}d.apply(b,c)},function(a){e.apply(b,c)})}else e()})}},{key:"filter",value:function(a){return Array.prototype.filter.call(this,function(b){return b.is(a)})}},{key:"toArray",value:function(){return Array.prototype.slice.call(this,0)}}]),b}(BEArray),BEObject=function(a){function b(a,c){void 0===a&&(a={}),_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,c),this.set(a)}return _inherits(b,a),_createClass(b,[{key:"fetch",value:function(){var a=this;return new Promise(function(b,c){if(a.id||a.nickname){var d=new BEApi(a._config()).get("objects/"+(a.id||a.nickname));return d.then(function(b){b&&b.data&&b.data.object?(a.set(b.data.object),a._modified(!1)):c(b)},function(a){c(a)}),d}c()})}},{key:"save",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.set(b);var c=this.toJSON(this._modified());return c.id=this.id,c.nickname=this.nickname,new Promise(function(b,d){var e=new BEApi(a._config()).post("objects",{data:c});e.then(function(c){c&&c.data&&c.data.object?(a.set(c.data.object),a._modified(!1),b(c)):d(c)},function(a){d(a)})})}},{key:"create",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(!this.isNew())throw"Object already created.";return this.save(a)}},{key:"remove",value:function(){var a=this;if(this.isNew())throw"Object has not a valid ID or a valid nickname.";return new Promise(function(b,c){var d=new BEApi(a._config())["delete"]("objects/"+(a.id||a.nickname));d.then(function(a){b()},function(a){c(a)})})}},{key:"clone",value:function(){return new b(this.toJSON([],["id"]),this._config())}},{key:"isNew",value:function(){return!this.id&&!this.nickname}},{key:"set",value:function(a,c){if(void 0===a&&(a={}),void 0!==c&&"string"==typeof a){var d=a;a={},a[d]=c}var e=a.relations||{},f=a.children||{},g=/\d{4,}\-\d{2,}\-\d{2,}T\d{2,}:\d{2,}:\d{2,}\+\d{4,}/;for(var h in e)this.relations||(this.relations={}),this.relations[h]=new BECollection(e[h],this._config());f&&!this.children&&(this.children=new BECollection({url:f.url,count:f.count},this._config()),f.sections&&(this.sections=new BECollection({alias:this.children,filter:{object_type:"Section"},url:f.sections.url,count:f.sections},this._config())));for(var h in a){var i=a[h];if("string"==typeof i&&24==i.length&&g.test(i)){var j=new Date(i);isNaN(j.valueOf())||(i=j)}this[h]!==i&&(this[h]=i,this._modified(h))}return a.parent_id?(this.parent=new b({id:a.parent_id}),delete this.parent_id):delete this.parent,this}},{key:"is",value:function(a){var b=this.toJSON();if(a instanceof RegExp){for(var c in b)if(b[c].match(a))return!0}else if("string"==typeof a){var d=new RegExp(a);for(var c in b)if(b[c].match(d))return!0}else if("object"==typeof a){for(var c in a)if(a[c]!==b[c])return!1;return!0}return!1}},{key:"query",value:function(){var a=this,b=new BEApiQueue(this._config());return"id"in this&&"nickname"in this?b.identity(this):b.objects(this.id||this.nickname),b.all(function(b){a.set(b),a._modified(!1)}),b}},{key:"toJSON",value:function(a,c){var d={},e=this;Array.isArray(a)||(a=[]),Array.isArray(c)||(c=[]);for(var f in e)-1!==b.unsetFromData.indexOf(f)||"function"==typeof e[f]||a&&a.length&&-1===a.indexOf(f)||c&&c.length&&-1!==c.indexOf(f)||(d[f]=e[f]);return d}}],[{key:"unsetFromData",get:function(){return["__modified","__config"]}}]),b}(BEModel),BEXhr=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"exec",value:function(){for(var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],c={type:"GET",async:!0,responseType:"json",headers:{},data:void 0},d={},e=[c,b],f=0;f<e.length;f++){var g=e[f];for(var h in g)d[h]=g[h]}return d.type=d.type.toUpperCase(),new Promise(function(b,c){var e=new a.xhr;if(e.addEventListener("load",function(){var a=void 0;try{a=e.response||e.responseText||""}catch(d){}if(a&&""!==a)try{a=JSON.parse(a)}catch(f){}e.status>=200&&e.status<400?b(a):c(a)},!1),e.addEventListener("error",function(){c(e)},!1),e.addEventListener("abort",function(){c(e)},!1),e.responseType=d.responseType,e.open(d.type,d.url,d.async),d.headers&&"object"==typeof d.headers)for(var f in d.headers)e.setRequestHeader(f,d.headers[f]);if("POST"==d.type||"PUT"==d.type&&void 0!==d.data){var g=d.data;"object"==typeof g&&(g=JSON.stringify(g)),e.send(g)}else e.send()})}},{key:"xhr",get:function(){return this._xhr?this._xhr:"object"==typeof module&&"object"==typeof module.exports?this.xhr=require("xmlhttprequest").XMLHttpRequest:window.XMLHttpRequest},set:function(a){this._xhr=a}}]),a}(),BEApiRegistry=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"add",value:function(b){var c=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];a._instances=a._instances||{},a._instances[b]=c}},{key:"getInstance",value:function(b){return a._instances=a._instances||{},"undefined"!=typeof a._instances[b]?a._instances[b]:void 0}},{key:"remove",value:function(b){return a._instances=a._instances||{},"undefined"!=typeof a._instances[b]?(delete a._instances[b],!0):!1}}]),a}(),BEApi=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,a);var c={baseUrl:void 0,accessTokenKey:"be_access_token",refreshTokenKey:"be_refresh_token",accessTokenExpireDate:"be_access_token_expire_date",configKey:this.defaultConfigKey};for(var d in b)c[d]=b[d];if(!c.baseUrl)try{c.baseUrl=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/api/latest/"}catch(e){throw"Missing valid `baseUrl`."}this.conf=c,BEApiRegistry.add(this.configKey,this.conf)}return _createClass(a,[{key:"getConfiguration",value:function(){return this.conf}},{key:"_processOptions",value:function(a){var b=this.conf;for(var c in a)b[c]=a[c];var d=b.url||"/",e=this.getAccessToken();if(/^([\w\-]+:)?\/{2,3}/.test(d)){if(0!==d.indexOf(b.baseUrl))throw"Invalid url"}else d="/"!==d[0]?b.baseUrl+("/"==b.baseUrl[b.baseUrl.length-1]?d:"/"+d):b.baseUrl+("/"==b.baseUrl[b.baseUrl.length-1]?d.slice(1):d);return b.url=d,e&&(b.headers=b.headers&&"object"==typeof b.headers?b.headers:{},b.headers.Authorization="Bearer "+e),b.type=b.method=b.type||b.method||"GET",b}},{key:"_processXHR",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return this.getAccessToken()&&this.isTokenExpired()?new Promise(function(c,d){var e=function(){var a=this,e=arguments;delete b.headers.Authorization,b=this._processOptions(b),BEXhr.exec(b).then(function(){c.apply(a,e)},function(){d.apply(a,e)})};a.refreshToken().then(e,e)}):BEXhr.exec(b)}},{key:"_processAuth",value:function(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];b.url="auth";var c=a.storage,d=this.conf,e=this.post(b);return e.then(function(a){a&&a.data&&a.data.access_token?(c.setItem(d.accessTokenKey,a.data.access_token),c.setItem(d.refreshTokenKey,a.data.refresh_token),c.setItem(d.accessTokenExpireDate,Date.now()+1e3*a.data.expires_in)):(c.removeItem(d.accessTokenKey),c.removeItem(d.refreshTokenKey),c.removeItem(d.accessTokenExpireDate))},function(){c.removeItem(d.accessTokenKey),c.removeItem(d.refreshTokenKey),c.removeItem(d.accessTokenExpireDate)}),e}},{key:"setBaseUrl",value:function(a){return this.conf.baseUrl=a,this}},{key:"get",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a=_processInput(a),a.type="GET",a=this._processOptions(a),this._processXHR(a)}},{key:"post",value:function(a,b){return void 0===a&&(a={}),a=_processInput(a),a.data=b?_extend(a.data||{},b):a.data,a.type="POST",a=this._processOptions(a),this._processXHR(a)}},{key:"put",value:function(a,b){return void 0===a&&(a={}),a=_processInput(a),a.data=b?_extend(a.data||{},b):a.data,a.type="PUT",a=this._processOptions(a),this._processXHR(a)}},{key:"delete",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return a=_processInput(a),a.type="DELETE",a=this._processOptions(a),this._processXHR(a)}},{key:"auth",value:function(a,b){var c={data:{username:a,password:b}};return this._processAuth(c)}},{key:"refreshToken",value:function(){var b=a.storage,c=this.conf,d={data:{grant_type:"refresh_token",refresh_token:this.getRefreshToken()}};return b.removeItem(c.accessTokenKey),b.removeItem(c.accessTokenExpireDate),this._processAuth(d)}},{key:"logout",value:function(){var b=a.storage,c=this.conf,d=this["delete"]({url:"auth/"+this.getRefreshToken()});return b.removeItem(c.accessTokenKey),b.removeItem(c.accessTokenExpireDate),d.then().then(function(a){a&&a.data&&a.data.logout&&b.removeItem(c.refreshTokenKey)})}},{key:"getAccessToken",value:function(){return a.storage.getItem(this.conf.accessTokenKey)||void 0}},{key:"getRefreshToken",value:function(){return a.storage.getItem(this.conf.refreshTokenKey)||void 0}},{key:"getAccessTokenExpireDate",value:function(){var b=a.storage.getItem(this.conf.accessTokenExpireDate);return b?(b=parseInt(b),new Date(b)):void 0}},{key:"isTokenExpired",value:function(){return new Date>=this.getAccessTokenExpireDate()}},{key:"defaultConfigKey",get:function(){return"default"}},{key:"configKey",get:function(){return this.conf&&this.conf.configKey||this.defaultConfigKey}}],[{key:"storage",get:function(){if(this._storage)return this._storage;if("object"==typeof module&&"object"==typeof module.exports){var b=require("node-localstorage").LocalStorage;return a.storage=new b("./beapi")}return"undefined"!=typeof localStorage?a.storage=window.localStorage:void 0},set:function(a){if("function"!=typeof a.setItem||"function"!=typeof a.getItem||"function"!=typeof a.removeItem)throw"Invalid custom storage.";this._storage=a}},{key:"xhr",get:function(){return BEXhr.xhr},set:function(a){BEXhr.xhr=a}}]),a}(),BEApiQueueTask=function a(b){var c=this,d=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];_classCallCheck(this,a),b&&(this.fn=b),this.args=d,this.promise=new Promise(function(a,b){c.resolve=a,c.reject=b})},BEApiQueue=function(){function a(b){var c=this;if(_classCallCheck(this,a),"string"==typeof b)this.conf=BEApiRegistry.getInstance(b);else if(b instanceof BEApi)this.conf=b.getConfiguration();else{if("object"!=typeof b)throw"No BEApi configuration provided.";this.conf=b}this._promise=new Promise(function(a,b){c._resolver=a,c._rejecter=b}),this.reset()}return _createClass(a,[{key:"reset",value:function(){return this.queue=[],this}},{key:"add",value:function(a){return this.queue.push(a),this}},{key:"exec",value:function(){function b(c,f,g){if(g=g||0,g==f.length)return c._resolver(e);var h=f[g],i=h.fn,j=h.args,k=h.resolve,l=h.reject,m=(h.promise,a.tasks[i]),n=new(_bind.apply(m,[null].concat(_toConsumableArray(j))));n.input.call(n,e).then(function(a){var h=n.type.toLowerCase();if("function"==typeof d[h]){var i=d[h].apply(d,a).then();i.then(function(a){n.validate(a).then(function(){n.transform(e,a).then(function(a){e=a,k(e),b(c,f,g+1)},function(a){l(e),c._rejecter(a)})},function(a){l(e),c._rejecter(a)})})}})}var c=this.queue,d=new BEApi(this.conf),e=void 0;return b(this,c),this._promise}},{key:"get",value:function(){return this.exec()}},{key:"first",value:function(){return this.queue.length?this.queue[0]:void 0}},{key:"last",value:function(){return this.queue.length?this.queue[this.queue.length-1]:void 0}},{key:"then",value:function(b,c){return this.queue.length?this.last().promise.then(b||a.__noop,c||a.__noop):this.all(b||a.__noop,c||a.__noop)}},{key:"all",value:function(b,c){return this._promise?this._promise.then(b||a.__noop,c||a.__noop):void 0}}],[{key:"register",value:function(b,c){if(b&&"undefined"!=typeof a.prototype[b])throw"Reserved method";a.tasks=a.tasks||{},a.tasks[b]=c,function(b){a.prototype[b]=function(){for(var a=arguments.length,c=Array(a),d=0;a>d;d++)c[d]=arguments[d];return this.add(new BEApiQueueTask(b,c)),this}}(b)}},{key:"__noop",value:function(){}}]),a}(),BEApiQueueBaseMethod=function(){function a(){var b=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,a),this.options=b}return _createClass(a,[{key:"type",get:function(){return"get"}}]),_createClass(a,[{key:"input",value:function(a){for(var b=arguments.length,c=Array(b>1?b-1:0),d=1;b>d;d++)c[d-1]=arguments[d];return new Promise(function(a){a(c)})}},{key:"validate",value:function(a){return new Promise(function(b,c){a&&a.data&&(!a.status||a.status>=200&&a.status<300)?b():c()})}},{key:"transform",value:function(a,b){return new Promise(function(b){b(a)})}}]),a}(),BEApiQueueIdentity=function(a){function b(a){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,{id:a.id,data:a})}return _inherits(b,a),_createClass(b,[{key:"validate",value:function(){return new Promise(function(a){a()})}},{key:"input",value:function(a){return new Promise(function(a){a([{url:"/"}])})}},{key:"transform",value:function(a,b){var c=this;return new Promise(function(a,b){a(c.options.data)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("identity",BEApiQueueIdentity);var BEApiQueueObjects=function(a){function b(a,c){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,{id:a,type:c})}return _inherits(b,a),_createClass(b,[{key:"input",value:function(a){var b=this;return new Promise(function(a){a([{url:(b.options.type?b.options.type+"s":"objects")+(b.options.id?"/"+b.options.id:"")}])})}},{key:"transform",value:function(a,b){return new Promise(function(c,d){b.data.object&&(a=b.data.object),c(a)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("objects",BEApiQueueObjects);var BEApiQueuePoster=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,a)}return _inherits(b,a),_createClass(b,[{key:"input",value:function(a){var b=this;return new Promise(function(c){var d="";if(b.options){d="?";for(var e in b.options)d+=e+"="+b.options[e]}c([{url:"poster/"+a.id+d}])})}},{key:"transform",value:function(a,b){return new Promise(function(c,d){b&&b.data&&(a.poster=b.data),c(a)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("poster",BEApiQueuePoster);var BEApiQueueRelation=function(a){function b(a){_classCallCheck(this,b),_get(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,{relName:a})}return _inherits(b,a),_createClass(b,[{key:"input",value:function(a){var b=this;return new Promise(function(c){c([{url:"objects/"+a.id+"/relations/"+b.options.relName}])})}},{key:"transform",value:function(a,b){var c=this;return new Promise(function(d,e){a.relations=a.relations||{},a.relations[c.options.relName]=a.relations[c.options.relName]||{},a.relations[c.options.relName].objects=b.data.objects,d(a)})}}]),b}(BEApiQueueBaseMethod);BEApiQueue.register("relation",BEApiQueueRelation);